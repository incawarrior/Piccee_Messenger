<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Piccee Messenger</title>

        <link rel="stylesheet" href="scripts/foundation/stylesheets\foundation.min.css">

    </head>
    <body>
        <div class="row">
            <div class="twelve columns">
                <div class="four columns" style="background-color: #f00">
                    <div id="myConversations" class="six columns">
                    </div>                   
                </div>
                <div class="six columns" style="background-color: #952ee6">
                    <div id="activeConversation" class="six columns">
                    </div>                   
                </div>
                <div class="two columns" style="background-color: #4cff00">
                   <div id="participantsProfile"></div>
                </div>
            </div>
        </div>
        
        <script src="scripts/system/jquery-1.8.2.min.js"></script>
        <!--<script src="scripts/system/handlebars-1.0.0.beta.6.js"></script>
        <script src="scripts/system/ember-1.0.pre.min.js"></script>
        <script src="scripts/pages/app.js"></script>-->
        <script src="http://www.parsecdn.com/js/parse-1.1.6.min.js"></script>

        <script>

            var initiator = "AdYMchLaiH";
            //var initiator = "L63FLWHQip";
            var participant = "LN6aIfzeIG";
            var currentUser;

            //EXAMPLE
            //https://projects.invisionapp.com/share/4A5WK2XJ#/2710170
            $(document).ready(function () {

                // Piccee-Dev
                var appId = 'yyQt1Xp0x9mKj5dAcmIZampwn3G4MC3iYawdDF9g';
                var jsKey = 'NWAbLes61CspfaPCEe8RPAnFAamdk3PYEAmYjbCy';

                Parse.initialize(appId, jsKey);

                //GetConversation();
                GetConversations();
            })

            function GetConversation() {
                var UserConversation = Parse.Object.extend("UserConversation");
                var q1;
                var q2;

                q1 = new Parse.Query(UserConversation);
                q2 = new Parse.Query(UserConversation);

                //For Testing: Since we don't have the actual user we have to create a pointer to the User Object.
                q1.equalTo('initiator', { __type: 'Pointer', className: '_User', objectId: initiator });
                //q1.equalTo('participant', { __type: 'Pointer', className: '_User', objectId: participant });
                q2.equalTo('participant', { __type: 'Pointer', className: '_User', objectId: initiator });
                //q2.equalTo('initiator', { __type: 'Pointer', className: '_User', objectId: participant });

                //This should be user for production.
                //q1.equalTo = ('initiator', initiator);
                //q1.equalTo = ('participant', participant);
                //q2.equalTo = ('participant', initiator);
                //q2.equalTo = ('initiator', participant);

                var query = Parse.Query.or(q1, q2);
                var html = "";

                query.find({
                    success: function (con) {
                        //alert("Messages where retrieved.");

                        for (var i in con) {
                            html += "<div>" + con[i].id + "</div>"
                        }

                        $("#activeConversation").html(html);
                    },
                    error: function (object, error) {
                        alert("An error occurred.");
                    }
                });
            }

            function GetConversations() {
                var UserConversation = Parse.Object.extend("UserConversation");

                var con1 = new Parse.Query(UserConversation);
                var con2 = new Parse.Query(UserConversation);

                con1.equalTo('initiator', { __type: 'Pointer', className: '_User', objectId: initiator });
                con2.equalTo('participant', { __type: 'Pointer', className: '_User', objectId: initiator });

                //We only want to display one conversation so
                //make sure we only get the latest conversation.
                var query = new Parse.Query.or(con1, con2);
                query.descending("updatedAt");

                var htmlConversations = "";
                var htmlMessages = "";
                var username = "";

                var userIDs = new Array();
                var userNames = new Array();
                var conversations = new Array();

                var currentIndex = 0;
                var counter = 0;
                var talkingTo = "";

                query.find({
                    success: function (convers) {
                        for (var i in convers) {
                            //Extract the person we are conversating with...

                            talkingTo = initiator == convers[i].attributes.initiator.id ?
                                                        convers[i].attributes.participant.id :
                                                        convers[i].attributes.initiator.id;

                            //Don't add duplicates.
                            if ($.inArray(talkingTo, userIDs) < 0) {
                                userIDs[counter] = talkingTo;
                                conversations[counter] = convers[i].id;
                                counter++;
                                //htmlConversations += "<div>" + "Talking To: " + talkingTo + "</div>"
                            }
                        }

                        //Now that we have all the users we need to get the username.
                        //----------------------------------------------------------------------------------------
                        var User = Parse.Object.extend("User");
                        var userQuery = new Parse.Query(User);

                        userQuery.containedIn("objectId", userIDs);
                        userQuery.find({
                            success: function (friends) {
                                for (var f in friends) {
                                    currentIndex = $.inArray(friends[f].id, userIDs);

                                    if (currentIndex >= 0) {
                                        userNames[currentIndex] = friends[f].attributes.username;
                                        htmlConversations += "<div>UserID: " + userIDs[currentIndex] + " Username: " + userNames[currentIndex] + " ConversationID: " + conversations[currentIndex] + "</div>";
                                    }
                                }
                                $("#myConversations").html(htmlConversations);

                                //Finally get the latest messages.
                                //--------------------------------------------------------------------------------
                                var UserMessage = Parse.Object.extend("UserMessage");
                                var userMessageQuery = new Parse.Query(UserMessage);

                                userMessageQuery.descending("updatedAt");
                                userMessageQuery.containedIn("userConversation", conversations);
                                userMessageQuery.find({
                                    success: function (msgs) {
                                        for (var m in msgs) {
                                            currentIndex = $.inArray(msgs[m]);
                                            htmlMessages += "<div>ConversationID: " + msgs[m].attributes.userConversion + " MessageID: " + msgs[m].id + " Message: " + msgs[m].attributes.message + "</div>";
                                        }
                                        
                                        $("#activeConversation").html(htmlMessages);
                                    },
                                    error: function (object, error) {
                                        alert("An error occurred");
                                    }
                                });


                            },
                            error: function (object, error) {
                                alert("An error occurred");
                            }
                        });
                        //----------------------------------------------------------------------------------------
                    },
                    error: function (object, error) {
                        alert("An error occurred");
                    }
                });
            }

            function GetUserName(userID) {
                var u = "";

                var queryUser = new Parse.Query(Parse.User);
                queryUser.equalTo("objectId", "AdYMchLaiH");

                queryUser.first({
                    success: function (user) {
                        u = user.attributes.username;
                    }
                });

                return u;
            }

        </script>
    </body>
</html>
