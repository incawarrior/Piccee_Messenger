<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Piccee Messenger</title>

        <link rel="stylesheet" href="scripts/foundation/stylesheets\foundation.min.css">

    </head>
    <body>
        <div class="row">
            <div class="twelve columns">
                <div class="four columns" style="background-color: #f00">
                    <div id="myConversations" class="six columns">
                    </div>                   
                </div>
                <div class="six columns" style="background-color: #952ee6">
                    <div id="activeConversation" class="six columns">
                    </div>                   
                </div>
                <div class="two columns" style="background-color: #4cff00">
                   <div id="participantsProfile"></div>
                </div>
            </div>
        </div>
        
        <script src="scripts/system/jquery-1.8.2.min.js"></script>
        <script src="http://www.parsecdn.com/js/parse-1.1.6.min.js"></script>
        <script>

            var initiator = "AdYMchLaiH";
            //var initiator = "L63FLWHQip";
            var participant = "LN6aIfzeIG";
            var UserConversation;
            var User;
            var q1;
            var q2;
            var currentUser;

            //EXAMPLE
            //https://projects.invisionapp.com/share/4A5WK2XJ#/2710170
            $(document).ready(function () {

                // Piccee-Dev
                var appId = 'yyQt1Xp0x9mKj5dAcmIZampwn3G4MC3iYawdDF9g';
                var jsKey = 'NWAbLes61CspfaPCEe8RPAnFAamdk3PYEAmYjbCy';

                Parse.initialize(appId, jsKey);

                UserConversation = Parse.Object.extend("UserConversation");

                q1 = new Parse.Query(UserConversation);
                q2 = new Parse.Query(UserConversation);

                q1.equalTo('initiator', { __type: 'Pointer', className: '_User', objectId: initiator });
                q1.equalTo('participant', { __type: 'Pointer', className: '_User', objectId: participant });

                q2.equalTo('participant', { __type: 'Pointer', className: '_User', objectId: initiator });
                q2.equalTo('initiator', { __type: 'Pointer', className: '_User', objectId: participant });

                var query = new Parse.Query.or(q1, q2);
                var html = "";

                query.find({
                    success: function (msgs) {
                        //alert("Messages where retrieved.");

                        for (var i in msgs) {
                            html += "<div>" + msgs[i].id + "</div>"
                        }

                        $("#activeConversation").html(html);
                    },
                    error: function (object, error) {
                        alert("An error occurred.");
                    }
                });

                GetConversations();

            })

            function GetConversation() {
            }

            function GetConversations() {
                var UserMessage = Parse.Object.extend("UserMessage");

                var con1 = new Parse.Query(UserMessage);
                var con2 = new Parse.Query(UserMessage);

                con1.equalTo('fromUser', { __type: 'Pointer', className: '_User', objectId: initiator });
                con2.equalTo('toUser', { __type: 'Pointer', className: '_User', objectId: initiator });

                var query = new Parse.Query.or(con1, con2);
                query.descending("updatedAt");

                var html = "";
                var username = "";

                //This is needed since Parse doesn't have Distinct capabilities.
                var previousConversation = "";

                query.find({
                    success: function (conversations) {
                        for (var i in conversations) {
                            //We only want to display one conversation so
                            //make sure we only get the latest conversation.
                            if (previousConversation != conversations[i].attributes.userConversation.id) {
                                //Get the username.
                                username = GetUserName(conversations[i].attributes.toUser.id);
                                html += "<div>" + "From: " + username + " " + conversations[i].attributes.message + "</div>"
                            }
                            previousConversation = conversations[i].attributes.userConversation.id;
                        }

                        $("#myConversations").html(html);
                    },
                    error: function (object, error) {
                        alert("An error occurred");
                    }
                });
            }

            function GetUserName(userID) {
                var u = "";
                
                var queryUser = new Parse.Query(Parse.User);
                queryUser.equalTo("objectId", "AdYMchLaiH");

                queryUser.first({
                    success: function (user) {
                        u = user.attributes.username;
                    }
                });

                return u;
            }

        </script>
    </body>
</html>
